# This is a Databricks asset bundle definition for data-air-quality-monitor.
# The Databricks extension requires databricks.yml configuration file.
# See https://docs.databricks.com/dev-tools/bundles/index.html for documentation.

bundle:
  name: data-air-quality-monitor

variables:
  name_prefix:
    description: Resource name prefix per environment
    default: dev
  warehouse_id:
    description: Default SQL warehouse for dashboards
    default: ""
  config_file_path:
    description: Path to the configuration file in Databricks workspace
    default: /

targets:
  dev:
    mode: development
    default: true
    workspace:
      host: https://dbc-42eed380-9a19.cloud.databricks.com # Replace with your Databricks workspace URL
    variables:
      name_prefix: dev
      warehouse_id: de7e5c8d731cb9c4 # Replace with your Databricks SQL warehouse ID
      config_file_path: /Workspace/Users/andrecaiado@gmail.com/data-air-quality-monitor-config/config.dev.py # Replace with your Databricks user account email
resources:
  jobs:
    data_air_quality_monitor_dimensions:
      name: ${var.name_prefix}-data-air-quality-monitor-dimensions
      email_notifications:
        on_failure:
          - andrecaiado@gmail.com # Replace with your email
      schedule:
        quartz_cron_expression: 0 0 0 ? * MON # Weekly on mondays at 00:00 AM
        timezone_id: UTC
        pause_status: UNPAUSED
      tasks:
        - task_key: Ingest_Locations_and_Sensors
          spark_python_task:
            python_file: ingest_bronze_locations.py
            parameters:
              - --config_file_path=${var.config_file_path}
          environment_key: Default
        - task_key: Build_Silver_Dimensions
          depends_on:
            - task_key: Ingest_Locations_and_Sensors
          spark_python_task:
            python_file: build_silver_dimensions.py
            parameters:
              - --config_file_path=${var.config_file_path}
          environment_key: Default
      queue:
        enabled: true
      environments:
        - environment_key: Default
          spec:
            dependencies:
              - -r
                requirements.txt
            environment_version: "4"
      performance_target: PERFORMANCE_OPTIMIZED
    data_air_quality_monitor_facts:
      name: ${var.name_prefix}-data-air-quality-monitor-facts
      email_notifications:
        on_failure:
          - andrecaiado@gmail.com # Replace with your email
      schedule:
        quartz_cron_expression: 0 0 0/2 * * ?
        timezone_id: UTC
        pause_status: UNPAUSED
      tasks:
        - task_key: Ingest_Bronze_Measurements
          spark_python_task:
            python_file: ingest_bronze_measurements.py
            parameters:
              - --country_code=PT
              - --config_file_path=${var.config_file_path}
          environment_key: Default
        - task_key: Transform_Silver_Measurements
          depends_on:
            - task_key: Ingest_Bronze_Measurements
          spark_python_task:
            python_file: transform_silver_measurements.py
            parameters:
              - --config_file_path=${var.config_file_path}
          environment_key: Default
        - task_key: Build_Gold_Measurements
          depends_on:
            - task_key: Transform_Silver_Measurements
          spark_python_task:
            python_file: build_gold_measurements.py
            parameters:
              - --config_file_path=${var.config_file_path}
          environment_key: Default
      queue:
        enabled: true
      environments:
        - environment_key: Default
          spec:
            dependencies:
              - -r
                requirements.txt
            environment_version: "4"
      performance_target: PERFORMANCE_OPTIMIZED
  dashboards:
    air_quality_dashboard:
      display_name: Air Quality Dashboard
      file_path: ./Air quality dashboard.lvdash.json
      warehouse_id: ${var.warehouse_id}
